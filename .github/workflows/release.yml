name: Release mongodb-datasource

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., 0.4.1)'
        required: true
        type: string
      version_postfix:
        description: 'Optional version postfix to distinguish multiple signed releases of the same version (e.g., 1, 2, rev1)'
        required: false
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}-proxy

jobs:
  plugin:
    runs-on: ubuntu-latest

    steps:
      - name: Download plugin release
        run: |
          VERSION="${{ inputs.version }}"
          # Remove 'v' prefix if present for filename
          VERSION_NO_V=${VERSION#v}
          # Ensure 'v' prefix for GitHub release tag URL
          if [[ ! "$VERSION" =~ ^v ]]; then
            RELEASE_TAG="v${VERSION}"
          else
            RELEASE_TAG="${VERSION}"
          fi
          PLUGIN_ZIP="haohanyang-mongodb-datasource-${VERSION_NO_V}.zip"
          curl -L -o plugin.zip "https://github.com/haohanyang/mongodb-datasource/releases/download/${RELEASE_TAG}/${PLUGIN_ZIP}"

      - name: Unzip plugin
        run: |
          unzip -q plugin.zip -d plugin-dist
          # Find the plugin directory (it might be nested)
          if [ -d "plugin-dist/haohanyang-mongodb-datasource" ]; then
            mv plugin-dist/haohanyang-mongodb-datasource plugin
          elif [ -d "plugin-dist" ]; then
            mv plugin-dist/* plugin
            rmdir plugin-dist
          else
            mkdir -p plugin
            mv plugin-dist/* plugin/ 2>/dev/null || true
          fi

      - name: Use Node.js 18
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: 18.x

      - name: Sign plugin
        env:
          GRAFANA_API_KEY: ${{ secrets.GRAFANA_API_KEY }}
          ROOT_URLS: https://dashboards.cloud.loftorbital.com,https://dashboards.sandbox.loftorbital.com
        run: |
          cd plugin
          npx --yes -p @grafana/sign-plugin --rootUrls "$ROOT_URLS"

      - name: Zip signed plugin
        id: zip
        run: |
          VERSION="${{ inputs.version }}"
          VERSION_NO_V=${VERSION#v}
          POSTFIX="${{ inputs.version_postfix }}"
          if [ -n "$POSTFIX" ]; then
            PLUGIN_ZIP="haohanyang-mongodb-datasource-${VERSION_NO_V}-signed-${POSTFIX}.zip"
            RELEASE_TAG="${VERSION}-${POSTFIX}"
          else
            PLUGIN_ZIP="haohanyang-mongodb-datasource-${VERSION_NO_V}-signed.zip"
            RELEASE_TAG="${VERSION}"
          fi
          cd plugin
          zip -qq -r "../${PLUGIN_ZIP}" .
          echo "filename=${PLUGIN_ZIP}" >> "$GITHUB_OUTPUT"
          echo "tag=${RELEASE_TAG}" >> "$GITHUB_OUTPUT"

      - name: Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: ${{ steps.zip.outputs.tag }}
          files: ${{ steps.zip.outputs.filename }}
